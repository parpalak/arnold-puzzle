<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Arnold's Puzzle</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch&display=swap" rel="stylesheet">
</head>
<body>
<canvas id="canvas"></canvas>
<div id="head">
    <h1>Arnold's Puzzle</h1>
    <div class="score"></div>
    <div class="goal">Dark regions: <span id="score"></span>/<span id="goal"></span></div>
</div>
<div id="bottom">
    <div id="info">
        <span onclick="if (event.ctrlKey) {displayDebugInfo();}">Â© 2020</span>
        <a class="link" id="mailto-link" title="Drop me a line" href="mailto:roman%40written.ru">Roman Parpalak</a>
    </div>
    <div id="instruction">Click triangles to flip. Get the maximum number of dark regions.</div>
</div>
<script src="utils.js"></script>
<script src="model.js"></script>
<script src="polygon.js"></script>
<script src="renderer.js"></script>
<script>
    const eCanvas = document.getElementById('canvas');
    const field = new Field();
    const n = localStorage.getItem('current_n');
    if (n) {
        field.setState(JSON.parse(localStorage.getItem('stored_' + n)));
    } else {
        // field.parseGenerators([0, 1, 0, 2, 1, 0, 3, 2, 1, 0]);
        field.parseGenerators([0, 1, 0, 2, 1, 0, 3, 2, 1, 0,
            4, 3, 2, 1, 0,
            5, 4, 3, 2, 1, 0,
            6, 5, 4, 3, 2, 1, 0,
            7, 6, 5, 4, 3, 2, 1, 0,
            // 8, 7, 6, 5, 4, 3, 2, 1, 0,
            // 9, 8, 7, 6, 5, 4, 3, 2, 1, 0,
            // 10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0,
            // 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0,
            // 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0,
            // 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0,
        ]);
        // field.parseGenerators([1, 3, 5, 7, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0, 3, 5, 7, 6, 5, 4, 3, 2, 1, 3, 5, 7, 8, 7, 6, 5, 4, 3, 5, 7, 9, 8, 7, 6, 5, 4, 3, 2, 1, 3, 5, 4, 5, 7, 6, 5, 7, 9, 8, 7, 9]);
    }

    recalcScore();

    const renderer = new Renderer(eCanvas, field, recalcScore);
    renderer.drawFrame();

    eCanvas.addEventListener('wheel', function (e) {
        let delta = e.deltaY || e.detail;

        if (!e.ctrlKey) {
            renderer.changeZoom(delta < 0 ? 1 : -1);
            renderer.drawFrame();
        }
    });

    let mousePressed = false, x, y, clickX, clickY;
    eCanvas.addEventListener('mousedown', function (e) {
        mousePressed = true;
        clickX = x = e.offsetX;
        clickY = y = e.offsetY;
    });
    eCanvas.addEventListener('mouseup', function (e) {
        mousePressed = false;
        if (e.button === 0 && Math.abs(e.offsetX - clickX) < 3 && Math.abs(e.offsetY - clickY) < 3) {
            setTimeout(() => {
                localStorage.setItem('stored_' + field.lineNum, JSON.stringify(field.getState()));
                localStorage.setItem('current_n', String(field.lineNum));
            }, 1000);
            renderer.doClick(e.offsetX, e.offsetY);
        }
    });
    eCanvas.addEventListener('mousemove', function (e) {
        if (mousePressed) {
            if (e.buttons % 2 === 0) {
                mousePressed = false;
                return;
            }
            renderer.shift(e.offsetX - x, e.offsetY - y);
            renderer.drawFrame();
            x = e.offsetX;
            y = e.offsetY;
        } else {
            this.style.cursor = renderer.canClick(e.offsetX, e.offsetY) ? 'pointer' : 'default';
        }
    });

    function displayDebugInfo() {
        const eInfo = document.getElementById('info');
        if (eInfo) {
            eInfo.innerHTML = [
                'E: ' + (field.w_pot + field.w_kin * 0.5).toFixed(6)
                , 'W: ' + field.w_pot.toFixed(6)
                , 'K: ' + (field.w_kin * 0.5).toFixed(6)
                , 'fps: ' + renderer.fps
//            , 'itns: ' + field.iterations
            ].map(val => '<span class="parameter">' + val + '</span>').join(' ');

            setTimeout(displayDebugInfo, 1000);
        }
    }

    function resizeHandler() {
        eCanvas.width = eCanvas.offsetWidth;
        eCanvas.height = eCanvas.offsetHeight;
        renderer.drawFrame();
    }

    window.addEventListener('resize', resizeHandler);
    document.addEventListener('readystatechange', resizeHandler);

    function recalcScore(score) {
        document.getElementById('score').innerHTML = score || field.darkPolygonNum();
    }

    document.getElementById('goal').innerHTML = field.darkPolygonNumLimit();

    renderer.toggleRun();
</script>
</body>
</html>
